import streamlit as st
import pandas as pd
from datetime import datetime
import io

# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ß‡∏±‡∏™‡∏î‡∏∏ Pro V.2", layout="wide")

# CSS: ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß, ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏≤‡∏Ç‡∏≠‡∏ö‡∏î‡∏≥, ‡∏õ‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏ô‡∏ï‡πå
st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
    html, body, [class*="css"] { 
        font-family: 'Sarabun', sans-serif; 
        background-color: #ffffff !important; 
    }
    
    /* ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Alignment */
    [data-testid="column"] { display: flex; align-items: flex-end; }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ ‡∏Ç‡∏≠‡∏ö‡∏î‡∏≥ */
    .stTextInput input, .stNumberInput input, .stSelectbox div[data-baseweb="select"] {
        font-size: 18px !important;
        font-weight: bold !important;
        background-color: #f2f2f2 !important; 
        border: 2px solid #000000 !important; 
        border-radius: 8px !important;
        color: #000000 !important;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î */
    div.stButton > button {
        width: 100%;
        height: 3.0rem;
        border-radius: 8px !important;
        background-color: #007bff;
        color: white;
        border: 1px solid #000;
    }

    /* ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ */
    .stTable { background-color: #ffffff; border: 1px solid #000; }
    .stExpander { border: 2px solid #000000 !important; background-color: #ffffff !important; border-radius: 10px !important; }
    </style>
""", unsafe_allow_html=True)

@st.cache_data
def load_data():
    file_name = "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï‡πÅ‡∏•‡∏∞‡∏´‡∏¥‡∏ô-‡∏Å‡∏£‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏•‡∏≤‡∏á3.csv"
    for enc in ['cp874', 'tis-620', 'utf-8-sig']:
        try:
            df = pd.read_csv(file_name, skiprows=2, header=None, encoding=enc, on_bad_lines='skip', low_memory=False)
            return df
        except: continue
    return None

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export Excel
def to_excel(df_detailed, df_summary, office, project):
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df_detailed.to_excel(writer, sheet_name='‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô', index=False)
        df_summary.to_excel(writer, sheet_name='‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°', index=False)
    return output.getvalue()

if 'calc_history' not in st.session_state:
    st.session_state.calc_history = []

st.markdown("<h1>üèóÔ∏è ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï‡πÅ‡∏•‡∏∞‡∏´‡∏¥‡∏ô</h1>", unsafe_allow_html=True)

try:
    df = load_data()
    if df is not None:
        col_p1, col_p2 = st.columns(2)
        office_name = col_p1.text_input("üè¢ ‡∏™‡∏≥‡∏ô‡∏±‡∏Å/‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:", placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏ô‡∏±‡∏Å...")
        project_work_name = col_p2.text_input("üìÑ ‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:", placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô...")
        
        st.caption(f"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏∞‡∏ö‡∏ö: {datetime.now().strftime('%d/%m/%Y')}")
        
        p_names = ["‡∏´‡∏¥‡∏ô‡πÉ‡∏´‡∏ç‡πà", "‡∏´‡∏¥‡∏ô‡∏¢‡πà‡∏≠‡∏¢", "‡∏ó‡∏£‡∏≤‡∏¢‡∏´‡∏¢‡∏≤‡∏ö", "‡∏õ‡∏π‡∏ô‡∏ã‡∏µ‡πÄ‡∏°‡∏ô‡∏ï‡πå", "‡∏´‡∏¥‡∏ô‡∏Ñ‡∏•‡∏∏‡∏Å", "‡πÄ‡∏´‡∏•‡πá‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï", "‡∏•‡∏ß‡∏î‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏•‡πá‡∏Å‡πÄ‡∏™‡∏£‡∏¥‡∏°"]

        # 1. ‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô
        st.markdown("### üìä 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô (Planned)")
        with st.expander("üìù ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥", expanded=True):
            col_plan = st.columns(len(p_names)) 
            planned_values = {}
            for i, name in enumerate(p_names):
                val = col_plan[i].number_input(f"{name}", min_value=0.0, value=None, placeholder="0.0", key=f"p_{i}")
                planned_values[name] = val if val is not None else 0.0

        st.divider()

        # 2. ‡∏£‡∏≤‡∏¢

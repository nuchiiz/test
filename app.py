# --- (‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠ 4. ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•) ---

            # 4. ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô
            st.divider()
            st.markdown("### üìä 4. ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô")
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            totals = {k: sum(item['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'].get(k, 0.0) for item in st.session_state.calc_history) for k in p_names}
            
            # ‡πÅ‡∏™‡∏î‡∏á Metrics 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)
            m_cols = st.columns(4) 
            for i, name in enumerate(p_names):
                m_cols[i % 4].metric(label=name, value=f"{totals[name]:,.3f}")

            # ‡∏™‡∏£‡πâ‡∏≤‡∏á DataFrame ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
            comparison_list = []
            for name in p_names:
                p_val = planned_values[name]
                a_val = totals[name]
                diff = p_val - a_val
                status = "‚úÖ ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô" if diff >= 0 else "‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô"
                comparison_list.append({
                    "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏": name,
                    "‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô (Planned)": p_val,
                    "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏£‡∏¥‡∏á (Actual)": a_val,
                    "‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (+‡πÄ‡∏´‡∏•‡∏∑‡∏≠/-‡πÄ‡∏Å‡∏¥‡∏ô)": diff,
                    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞": status
                })
            
            df_comp = pd.DataFrame(comparison_list)

            # ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            def style_comparison(row):
                styles = [''] * len(row)
                # ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏•‡∏ö (‡πÄ‡∏Å‡∏¥‡∏ô‡πÅ‡∏ú‡∏ô) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á
                if row['‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (+‡πÄ‡∏´‡∏•‡∏∑‡∏≠/-‡πÄ‡∏Å‡∏¥‡∏ô)'] < 0:
                    styles[3] = 'color: red; font-weight: bold;' # ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á
                    styles[4] = 'background-color: #ffcccc; color: red; font-weight: bold;' # ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                else:
                    styles[3] = 'color: green; font-weight: bold;'
                    styles[4] = 'background-color: #e6ffed; color: green;'
                return styles

            # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á
            st.table(df_comp.style.format({
                "‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô (Planned)": "{:,.3f}", 
                "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏£‡∏¥‡∏á (Actual)": "{:,.3f}", 
                "‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (+‡πÄ‡∏´‡∏•‡∏∑‡∏≠/-‡πÄ‡∏Å‡∏¥‡∏ô)": "{:,.3f}"
            }).apply(style_comparison, axis=1))

# --- (‡∏™‡πà‡∏ß‡∏ô Export ‡πÅ‡∏•‡∏∞ Link Button ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
